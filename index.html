<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAM Valid Editor V2</title>
    <style>
        :root { --bg: #111; --panel: #222; --accent: #007acc; --text: #ccc; --err: #ff5555; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: #333; padding: 10px; border-bottom: 1px solid #444; display: flex; gap: 10px; align-items: center; }
        .main { display: flex; flex: 1; overflow: hidden; }
        .canvas-area { flex: 2; display: flex; flex-direction: column; background: #000; position: relative; }
        #canvas { border: 1px solid #333; margin: auto; max-width: 90%; max-height: 80%; }
        .side { flex: 1; background: var(--panel); display: flex; flex-direction: column; border-left: 1px solid #444; min-width: 350px; }
        .label-list { flex: 1; overflow-y: auto; margin: 0; padding: 0; list-style: none; border-bottom: 1px solid #444; }
        .label-item { padding: 8px 15px; border-bottom: 1px solid #333; cursor: pointer; display: flex; justify-content: space-between; font-size: 14px; }
        .label-item:hover { background: #333; }
        .label-item.active { background: var(--accent); color: white; }
        .controls { padding: 15px; background: #252525; display: flex; flex-direction: column; gap: 10px; }
        .btn { padding: 8px; border: none; border-radius: 4px; cursor: pointer; color: white; background: #444; font-weight: bold; }
        .btn-save { background: #28a745; }
        .btn-add { background: var(--accent); }
        .btn-del { background: #dc3545; }
        input { background: #000; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px; }
        .debug-log { height: 80px; background: #000; color: #0f0; font-family: monospace; font-size: 11px; padding: 5px; overflow-y: auto; border-top: 2px solid #444; }
        .upload-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 12px; font-weight: bold; color: #888; }
    </style>
</head>
<body>

<header>
    <div class="upload-group">
        <label>1. PAM JSON</label>
        <input type="file" id="jsonIn" accept=".json">
    </div>
    <div class="upload-group">
        <label>2. MEDIA FOLDER</label>
        <input type="file" id="mediaIn" webkitdirectory directory multiple>
    </div>
    <div style="margin-left:auto">
        <button class="btn btn-save" onclick="exportPAM()">ðŸ’¾ DOWNLOAD VALID PAM</button>
    </div>
</header>

<div class="main">
    <div class="canvas-area">
        <canvas id="canvas"></canvas>
        <div id="frameDisplay" style="text-align:center; padding:10px; color:#666">No File Loaded</div>
    </div>
    <div class="side">
        <ul id="list" class="label-list"></ul>
        <div class="controls">
            <input type="text" id="nameIn" placeholder="Label Name">
            <div style="display:flex; gap:5px">
                <button class="btn" style="flex:1" onclick="rename()">Rename</button>
                <button class="btn btn-add" style="flex:1" onclick="addNew()">New Label</button>
            </div>
            <button class="btn btn-del" onclick="remove()">Delete Label</button>
        </div>
    </div>
</div>

<div id="log" class="debug-log">System Ready...</div>

<script>
    let rawData = null;
    let selectedIdx = -1;
    const logEl = document.getElementById('log');

    function log(msg, isErr = false) {
        const div = document.createElement('div');
        div.style.color = isErr ? '#ff5555' : '#0f0';
        div.innerText = `> ${msg}`;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
    }

    // --- UPLOAD ---
    document.getElementById('jsonIn').onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                rawData = JSON.parse(ev.target.result);
                if(!rawData.main_sprite || !rawData.main_sprite.frame) {
                    throw new Error("Missing 'main_sprite.frame' structure.");
                }
                log(`Loaded: ${file.name} (${rawData.main_sprite.frame.length} frames)`);
                updateList();
            } catch (err) {
                log("VALIDATION ERROR: " + err.message, true);
            }
        };
        reader.readAsText(file);
    };

    // --- LOGIC ---
    function updateList() {
        const list = document.getElementById('list');
        list.innerHTML = '';
        rawData.main_sprite.frame.forEach((f, i) => {
            if (f.label) {
                const li = document.createElement('li');
                li.className = 'label-item' + (selectedIdx === i ? ' active' : '');
                li.innerHTML = `<span><b>${f.label}</b></span> <span>F:${i}</span>`;
                li.onclick = () => {
                    selectedIdx = i;
                    document.getElementById('nameIn').value = f.label;
                    document.getElementById('frameDisplay').innerText = `Current Frame: ${i} | Label: ${f.label}`;
                    updateList();
                };
                list.appendChild(li);
            }
        });
    }

    function rename() {
        if (selectedIdx < 0) return log("Select a label first!", true);
        const old = rawData.main_sprite.frame[selectedIdx].label;
        const next = document.getElementById('nameIn').value;
        rawData.main_sprite.frame[selectedIdx].label = next;
        log(`Renamed [${old}] to [${next}]`);
        updateList();
    }

    function addNew() {
        if (!rawData) return;
        const f = prompt("Enter Frame Number (0 to " + (rawData.main_sprite.frame.length-1) + "):");
        const n = prompt("Enter Label Name:");
        if (f !== null && n && rawData.main_sprite.frame[f]) {
            rawData.main_sprite.frame[f].label = n;
            log(`Added label [${n}] to frame ${f}`);
            updateList();
        } else {
            log("Invalid frame or name", true);
        }
    }

    function remove() {
        if (selectedIdx < 0) return;
        log(`Removed label: ${rawData.main_sprite.frame[selectedIdx].label}`);
        rawData.main_sprite.frame[selectedIdx].label = "";
        selectedIdx = -1;
        updateList();
    }

    // --- EXPORT ---
    function exportPAM() {
        if (!rawData) return log("Nothing to export!", true);
        try {
            // Using \t (tabs) to match the PvZ PAM formatting style
            const blob = new Blob([JSON.stringify(rawData, null, "\t")], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "pecanolith.pam.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            log("Export successful! Valid JSON generated.");
        } catch (err) {
            log("EXPORT ERROR: " + err.message, true);
        }
    }
</script>
</body>
</html>